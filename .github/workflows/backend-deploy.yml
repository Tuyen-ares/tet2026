name: Backend CI and Deploy

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - ".github/workflows/backend-deploy.yml"
  workflow_dispatch:

concurrency:
  group: backend-deploy
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: backend/package-lock.json

      - name: Install deps
        run: npm ci

      - name: Optional test
        run: |
          if node -e "const s=require('./package.json').scripts||{}; process.exit(s.test?0:1)"; then
            npm test
          else
            echo "No test script found, skipping."
          fi

      - name: Optional build
        run: |
          if node -e "const s=require('./package.json').scripts||{}; process.exit(s.build?0:1)"; then
            npm run build
          else
            echo "No build script found, skipping."
          fi

  deploy:
    runs-on: ubuntu-latest
    needs: ci
    steps:
      - name: Trigger Render deploy
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
          LEGACY_RENDER_HOOK_URL: ${{ secrets.NAMMOIVUIVE }}
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          HOOK_URL="${RENDER_DEPLOY_HOOK_URL:-$LEGACY_RENDER_HOOK_URL}"
          if [ -n "$HOOK_URL" ]; then
            echo "Triggering Render via deploy hook..."
            HTTP_CODE=$(curl -sS -o /tmp/render_hook_body.txt -w "%{http_code}" -X POST "$HOOK_URL" || true)
            if [ "${HTTP_CODE}" -ge 200 ] && [ "${HTTP_CODE}" -lt 300 ]; then
              echo "Render deploy hook triggered successfully (HTTP ${HTTP_CODE})."
              exit 0
            fi
            echo "Deploy hook failed with HTTP ${HTTP_CODE}. Trying API fallback..."
          else
            echo "No deploy hook secret found. Trying API fallback..."
          fi

          if [ -z "$RENDER_API_KEY" ] || [ -z "$RENDER_SERVICE_ID" ]; then
            echo "Missing Render API fallback secrets (RENDER_API_KEY, RENDER_SERVICE_ID)."
            echo "Set a valid RENDER_DEPLOY_HOOK_URL from Render Dashboard > Service > Settings > Deploy Hook."
            exit 1
          fi

          HTTP_CODE=$(curl -sS -o /tmp/render_api_body.txt -w "%{http_code}" -X POST \
            "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" \
            -d '{"clearCache":"do_not_clear"}' || true)

          if [ "${HTTP_CODE}" -ge 200 ] && [ "${HTTP_CODE}" -lt 300 ]; then
            echo "Render deploy triggered via API fallback (HTTP ${HTTP_CODE})."
            exit 0
          fi

          echo "Render API fallback failed with HTTP ${HTTP_CODE}."
          cat /tmp/render_api_body.txt || true
          exit 1
